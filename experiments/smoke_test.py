# Generated by claude code
"""
Smoke test for RAG pipeline with manual questions.
Tests the end-to-end flow: query → retrieval → generation.

Usage:
    python -m experiments.smoke_test
"""

import json
from pathlib import Path
from src.rag_pipeline import RagAssistant

PROJECT_ROOT = Path(__file__).parent.parent
TEST_QUESTIONS_PATH = PROJECT_ROOT / "data" / "eval" / "test_questions.json"


def load_test_questions():
    """Load test questions from JSON file."""
    with open(TEST_QUESTIONS_PATH, "r") as f:
        return json.load(f)


def main():
    model = "qwen2.5-coder:7b"
    # model = "gpt-4o-mini"

    print("=" * 80)
    print("RAG PIPELINE SMOKE TEST")
    print("=" * 80)

    # Load test questions from JSON
    all_questions = load_test_questions()

    # For smoke test, use first 5 questions (mix of types)
    test_questions = [
        q
        for q in all_questions
        if q["id"]
        in ["factual_1", "reasoning_1", "reasoning_2", "multihop_1", "negative_1"]
    ]
    assistant = RagAssistant()

    # Test all 4 modes: hybrid, dense, sparse, none
    modes = ["hybrid", "dense", "sparse", "none"]

    for mode in modes:
        print(f"\n{'='*80}")
        print(f"MODE: {mode.upper()}")
        print(f"{'='*80}\n")


        for q in test_questions:
            print(f"{'='*80}\n")
            print(f"\n[{q['id']}] {q['question']}")
            if "notes" in q:
                print(f"    (Expected: {q['notes']})")
            print("-" * 80)

            try:
                answer, _context = assistant.query(q["question"], model=model, retrieval_mode=mode)
                print(f"[Answer] {answer}\n")
            except Exception as e:
                print(f"[ERROR] {e}\n")

    print("\n" + "=" * 80)
    print("SMOKE TEST COMPLETE")
    print("=" * 80)


if __name__ == "__main__":
    main()
