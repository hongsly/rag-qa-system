# Generated by Claude Code
"""
Analyze if BM25 is retrieving reference sections
Check if we should filter them out
"""
import json
from pathlib import Path


def analyze_chunk_types():
    project_root = Path(__file__).parent.parent
    chunks_path = project_root / "data" / "processed" / "chunks.jsonl"

    # Load all chunks
    chunks = []
    with open(chunks_path, "r") as f:
        for line in f:
            chunks.append(json.loads(line))

    print(f"Total chunks: {len(chunks)}")

    # Identify reference chunks
    reference_indicators = [
        "References",
        "REFERENCES",
        "Bibliography",
        "BIBLIOGRAPHY",
        "[1]", "[2]", "[3]", "[4]", "[5]",  # Citation numbers
        "et al.",
        "In: _Proceedings",
        "arxiv.org",
        "doi.org",
    ]

    reference_chunks = []
    for chunk in chunks:
        text = chunk["chunk_text"]
        # Check if chunk looks like references
        score = 0
        for indicator in reference_indicators:
            if indicator in text:
                score += 1

        if score >= 2:  # At least 2 indicators
            reference_chunks.append(chunk)

    print(f"Reference-like chunks: {len(reference_chunks)} ({len(reference_chunks)/len(chunks)*100:.1f}%)")

    # Show examples
    print("\n" + "=" * 100)
    print("SAMPLE REFERENCE CHUNKS:")
    print("=" * 100)
    for chunk in reference_chunks[:5]:
        print(f"\nChunk ID: {chunk['chunk_id']}")
        print(f"Content: {chunk['chunk_text'][:300]}...")
        print("-" * 100)

    # Check specific chunks that BM25 retrieved
    print("\n" + "=" * 100)
    print("CHECKING BM25 RESULTS FROM EARLIER:")
    print("=" * 100)

    problem_chunks = [
        "2312.00752_rag_roadmap_asaichunk_26550",  # "An At..." from Query 1
        "2312.00752_rag_roadmap_asaichunk_22500",  # From Query 1
    ]

    chunk_lookup = {c["chunk_id"]: c for c in chunks}

    for chunk_id in problem_chunks:
        if chunk_id in chunk_lookup:
            chunk = chunk_lookup[chunk_id]
            print(f"\nChunk ID: {chunk_id}")
            print(f"Content: {chunk['chunk_text'][:500]}...")

            # Check if it's a reference
            is_reference = sum(1 for indicator in reference_indicators if indicator in chunk['chunk_text']) >= 2
            print(f"Is reference section? {is_reference}")
            print("-" * 100)


if __name__ == "__main__":
    analyze_chunk_types()
